!function(e){var o={};function s(n){if(o[n])return o[n].exports;var t=o[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.m=e,s.c=o,s.d=function(e,o,n){s.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,o){if(1&o&&(e=s(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)s.d(n,t,function(o){return e[o]}.bind(null,t));return n},s.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(o,"a",o),o},s.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},s.p="",s(s.s=4)}([function(e,o){e.exports=require("koa-router")},function(e,o){e.exports=require("@shopify/koa-shopify-auth")},function(e,o){e.exports=require("@shopify/koa-shopify-graphql-proxy")},function(e,o,s){const n=s(16);e.exports={addShop:function(e,o){const s=process.env.APP_FREE_TRIAL_PERIOD;this.findShopByName(e).then(t=>{if(!t){t={shop_origin:e,access_token:o,added_time:n.getCurrentTimestamp(),trial_expire_time:Math.floor((new Date).getTime()/1e3)+24*s*60*60};return new Promise((function(e,o){db.query("INSERT INTO shops SET ?",t,(function(s,n){return s?o(s):e(n)}))}))}this.updateShop(e,{access_token:o})})},findShopByName:function(e){return new Promise((function(o,s){db.query("SELECT * FROM shops WHERE shop_origin = ?",e,(function(e,n){return e?s(e):n.length>0?o(n[0]):o(null)}))}))},updateShop:function(e,o){return new Promise((function(s,n){db.query("UPDATE shops SET ? WHERE shop_origin = ?",[o,e],(function(e,o){return e?n(e):s(o)}))}))}}},function(e,o,s){s(5),s(6).config(),s(7);const n=s(8),t=s(9),r=s(10),{default:i}=s(1),{verifyRequest:c}=s(1),a=s(11),u=s(12),p=s(0),l=s(13),d=s(14),{default:f}=s(2),{ApiVersion:h}=s(2),{receiveWebhook:y,registerWebhook:S}=s(15);var _=r.createConnection({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME});_.connect((function(e){if(e)throw e;console.log("> Connected to mysql server")})),global.db=_;const g=parseInt(process.env.PORT,10)||3e3,b=t({dev:!1}),k=b.getRequestHandler(),{SHOPIFY_API_SECRET_KEY:m,SHOPIFY_API_KEY:E,HOST:P}=process.env;b.prepare().then(()=>{const e=new n;e.context.db=_,e.use(a({secure:!0,sameSite:"none"},e)),e.keys=[m],e.use(i({apiKey:E,secret:m,scopes:["read_orders","write_orders"],accessMode:"offline",async afterAuth(e){const{shop:o,accessToken:n}=e.session;e.cookies.set("shopOrigin",o,{httpOnly:!1,secure:!0,sameSite:"none"}),console.log(`> Authenticated: ${o} - ${n}`);const t=s(3);Promise.all([S({address:P+"/webhook/orders/create",topic:"ORDERS_CREATE",accessToken:n,shop:o,apiVersion:h.July20}),S({address:P+"/webhook/orders/cancelled",topic:"ORDERS_CANCELLED",accessToken:n,shop:o,apiVersion:h.July20}),S({address:P+"/webhook/orders/paid",topic:"ORDERS_PAID",accessToken:n,shop:o,apiVersion:h.July20}),S({address:P+"/webhook/orders/fulfilled",topic:"ORDERS_FULFILLED",accessToken:n,shop:o,apiVersion:h.July20}),S({address:P+"/webhook/orders/partially_fulfilled",topic:"ORDERS_PARTIALLY_FULFILLED",accessToken:n,shop:o,apiVersion:h.July20}),S({address:P+"/webhook/subscriptions/update",topic:"APP_SUBSCRIPTIONS_UPDATE",accessToken:n,shop:o,apiVersion:h.July20}),t.addShop(o,n)]).then(e=>{e[0].success&&e[1].success&&e[2].success&&e[3].success&&e[4].success&&e[5].success?console.log("> Webhook Registered: "+o):console.log("> Webhook registration failed: "+o)}),e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME)}})),e.use(f({version:h.July20})),e.use(l("./public")),e.use(u());const o=new p,t=y({secret:m}),r=s(17)(t),b=s(18)(c);o.all("/(.*)",c(),async e=>{await k(e.req,e.res),e.respond=!1,e.res.statusCode=200}),e.use(r.routes()),e.use(r.allowedMethods()),e.use(d()),e.use(b.routes()),e.use(b.allowedMethods()),e.use(o.routes()),e.use(o.allowedMethods()),e.listen(g,()=>{console.log("> Server started on port: "+g)})})},function(e,o){e.exports=require("isomorphic-fetch")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("module-alias/register")},function(e,o){e.exports=require("koa")},function(e,o){e.exports=require("next")},function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("koa-session")},function(e,o){e.exports=require("@koa/cors")},function(e,o){e.exports=require("koa-static")},function(e,o){e.exports=require("koa-body")},function(e,o){e.exports=require("@shopify/koa-shopify-webhooks")},function(e,o){e.exports={getCurrentTimestamp:function(){const e=new Date;return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)}}},function(e,o,s){const n=new(s(0))({prefix:"/webhook"});e.exports=function(e){return n.post("/orders/create",e,async e=>{console.log("> New order created: ")}),n.post("/subscriptions/update",e,async e=>{console.log("> -------Subscription update---------"),console.log(e.query),console.log(e.request.body),console.log(e.params),console.log(e.body),console.log("> -------Subscription update---------")}),n}},function(e,o,s){const n=new(s(0)),t=s(3),r=s(19);e.exports=function(e){return n.get("/api/settings",e(),async e=>{}),n.post("/api/settings",e(),async e=>{}),n.get("/api/subscription",e(),async e=>{const o=e.session.shop,s=await t.findShopByName(o),n=e.query.plan;if(console.log(`> Chosen a plan: ${o} - ${n}`),s.plan==n||"basic"!=n&&"premium"!=n)return void e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME);var r=process.env.APP_BASIC_PLAN_FEE;"premium"==n&&(r=process.env.APP_PREMIUM_PLAN_FEE);const i=JSON.stringify({query:`mutation {\n        appSubscriptionCreate(\n          name: "Slackify ${n} plan fee"\n          returnUrl: "${process.env.HOST}/subscription/callback"\n          test: true\n          lineItems: [\n            {\n              plan: {\n                appRecurringPricingDetails: {\n                  price: { amount: ${r}, currencyCode: USD }\n                  interval: EVERY_30_DAYS\n                }\n              }\n            }\n          ]\n        ) {\n          userErrors {\n            field\n            message\n          }\n          confirmationUrl\n          appSubscription {\n            id\n          }\n        }\n      }`}),c=await fetch(`https://${o}/admin/api/2020-07/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":s.access_token},body:i}),a=(await c.json()).data.appSubscriptionCreate.confirmationUrl;e.redirect(a)}),n.get("/subscription/callback",e(),e=>{const o=e.session.shop,s=e.query.charge_id;console.log(`> Subscription activated: ${o} - ${s}`)}),n.get("/slack/oauth",e(),async e=>{const o=e.session.shop;if(e.query.code)return new Promise((function(s,n){r({url:"https://slack.com/api/oauth.v2.access",qs:{code:e.query.code,client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET},method:"GET"},(function(n,r,i){if(n)console.log("> Slack authentication error: "+n),e.response.status=500,e.response.body="Failed to add Slackify to a Slack channel.",s();else{const n=JSON.parse(i);n.ok?(t.updateShop(o,{slack_access:i,slack_webhook_url:n.incoming_webhook.url}),e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME)):(console.log("> Slack authentication failed: "+n.error),e.response.status=500,e.response.body="Failed to add Slackify to the Slack channel."),s()}}))}));console.log("> Invalid slack authentication code: "+o),e.response.status=500,e.response.body="Invalid slack authentication code."}),n}},function(e,o){e.exports=require("request")}]);