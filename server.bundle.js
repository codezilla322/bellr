!function(e){var o={};function s(n){if(o[n])return o[n].exports;var t=o[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.m=e,s.c=o,s.d=function(e,o,n){s.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,o){if(1&o&&(e=s(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)s.d(n,t,function(o){return e[o]}.bind(null,t));return n},s.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(o,"a",o),o},s.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},s.p="",s(s.s=4)}([function(e,o){e.exports=require("koa-router")},function(e,o,s){const n=s(16);e.exports={addShop:function(e,o,s=1){const t=process.env.APP_FREE_TRIAL_PERIOD;this.findShopByName(e).then(r=>{if(!r){r={shop_origin:e,access_token:o,added_time:n.getCurrentTimestamp(),trial_expire_time:Math.floor((new Date).getTime()/1e3)+24*t*60*60,is_webhook_registered:s};return new Promise((function(e,o){db.query("INSERT INTO shops SET ?",r,(function(s,n){return s?o(s):e(n)}))}))}this.updateShop(e,o,s)})},findShopByName:function(e){return new Promise((function(o,s){db.query("SELECT * FROM shops WHERE shop_origin = ?",e,(function(e,n){return e?s(e):n.length>0?o(n[0]):o(null)}))}))},updateShop:function(e,o,s=1){return new Promise((function(n,t){db.query("UPDATE shops SET access_token = ?, is_webhook_registered = ? WHERE shop_origin = ?",[o,s,e],(function(e,o){return e?t(e):n(o)}))}))},updateShopSlack:function(e,o,s){return new Promise((function(n,t){db.query("UPDATE shops SET slack_access = ?, slack_webhook_url = ? WHERE shop_origin = ?",[o,s,e],(function(e,o){return e?t(e):n(o)}))}))},getSubscriptionUrl:async function(e,o,s,n){const t=JSON.stringify({query:`mutation {\n        appSubscriptionCreate(\n          name: "Slackify ${s} plan fee"\n          returnUrl: "${process.env.HOST}/plan/paid"\n          test: true\n          lineItems: [\n            {\n              plan: {\n                appRecurringPricingDetails: {\n                  price: { amount: ${n}, currencyCode: USD }\n                  interval: EVERY_30_DAYS\n                }\n              }\n            }\n          ]\n        ) {\n          userErrors {\n            field\n            message\n          }\n          confirmationUrl\n          appSubscription {\n            id\n          }\n        }\n      }`}),r=await fetch(`https://${e}/admin/api/2020-07/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":o},body:t});return(await r.json()).data.appSubscriptionCreate.confirmationUrl}}},function(e,o){e.exports=require("@shopify/koa-shopify-auth")},function(e,o){e.exports=require("@shopify/koa-shopify-graphql-proxy")},function(e,o,s){s(5),s(6).config(),s(7);const n=s(8),t=s(9),r=s(10),{default:i}=s(2),{verifyRequest:c}=s(2),a=s(11),u=s(12),p=s(0),l=s(13),d=s(14),{default:f}=s(3),{ApiVersion:h}=s(3),{receiveWebhook:y,registerWebhook:g}=s(15);var S=r.createConnection({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME});S.connect((function(e){if(e)throw e;console.log("> Connected to mysql server")})),global.db=S;const _=parseInt(process.env.PORT,10)||3e3,k=t({dev:!1}),b=k.getRequestHandler(),{SHOPIFY_API_SECRET_KEY:E,SHOPIFY_API_KEY:m,HOST:w}=process.env;k.prepare().then(()=>{const e=new n;e.context.db=S,e.use(a({secure:!0,sameSite:"none"},e)),e.keys=[E],e.use(i({apiKey:m,secret:E,scopes:["read_orders","write_orders"],accessMode:"offline",async afterAuth(e){const{shop:o,accessToken:n}=e.session;e.cookies.set("shopOrigin",o,{httpOnly:!1,secure:!0,sameSite:"none"}),console.log("> Authenticated: "+o+" - "+n);const t=s(1),r=await t.findShopByName(o);if(r&&0!=r.is_webhook_registered)r.access_token!=n&&t.addShop(o,n);else{let e=1;Promise.all([g({address:w+"/webhooks/orders/create",topic:"ORDERS_CREATE",accessToken:n,shop:o,apiVersion:h.July20}),g({address:w+"/webhooks/orders/cancelled",topic:"ORDERS_CANCELLED",accessToken:n,shop:o,apiVersion:h.July20}),g({address:w+"/webhooks/orders/paid",topic:"ORDERS_PAID",accessToken:n,shop:o,apiVersion:h.July20}),g({address:w+"/webhooks/orders/fulfilled",topic:"ORDERS_FULFILLED",accessToken:n,shop:o,apiVersion:h.July20}),g({address:w+"/webhooks/orders/partially_fulfilled",topic:"ORDERS_PARTIALLY_FULFILLED",accessToken:n,shop:o,apiVersion:h.July20})]).then(s=>{s[0].success&&s[1].success&&s[2].success&&s[3].success&&s[4].success?console.log("> Webhook Registered"):(console.log("> Webhook registration failed"),e=0),t.addShop(o,n,e)})}e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME)}})),e.use(f({version:h.July20})),e.use(l("./public")),e.use(u()),e.use(d());const o=new p,t=s(17),r=s(18),k=y({secret:E}),v=s(20)(k),P=s(21)(c);o.all("/(.*)",c(),async e=>{await b(e.req,e.res),e.respond=!1,e.res.statusCode=200}),e.use(t.routes()),e.use(t.allowedMethods()),e.use(r.routes()),e.use(r.allowedMethods()),e.use(v.routes()),e.use(v.allowedMethods()),e.use(P.routes()),e.use(P.allowedMethods()),e.use(o.routes()),e.use(o.allowedMethods()),e.listen(_,()=>{console.log("> Server started on port: "+_)})})},function(e,o){e.exports=require("isomorphic-fetch")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("module-alias/register")},function(e,o){e.exports=require("koa")},function(e,o){e.exports=require("next")},function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("koa-session")},function(e,o){e.exports=require("@koa/cors")},function(e,o){e.exports=require("koa-static")},function(e,o){e.exports=require("koa-body")},function(e,o){e.exports=require("@shopify/koa-shopify-webhooks")},function(e,o){e.exports={getCurrentTimestamp:function(){const e=new Date;return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)}}},function(e,o,s){const n=new(s(0))({prefix:"/api"});n.get("/settings",async e=>{e.body=""}),n.post("/settings",async e=>{}),e.exports=n},function(e,o,s){const n=new(s(0))({prefix:"/slack"}),t=s(1),r=s(19);n.get("/oauth",async e=>{const o=e.session.shop;return o?e.query.code?new Promise((function(s,n){r({url:"https://slack.com/api/oauth.v2.access",qs:{code:e.query.code,client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET},method:"GET"},(function(n,r,i){if(n)console.log("> Slack authentication error: "+n),e.response.status=500,e.response.body="Failed to add Slackify to a Slack channel.",s();else{const n=JSON.parse(i);n.ok?(t.updateShopSlack(o,i,n.incoming_webhook.url),e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME)):(console.log("> Slack authentication failed: "+n.error),e.response.status=500,e.response.body="Failed to add Slackify to the Slack channel."),s()}}))})):(console.log("> Invalid slack authentication code - "+o),e.response.status=500,void(e.response.body="Invalid slack authentication code.")):(e.response.status=500,void(e.response.body="Try Slackify integration from Shopify Admin panel."))}),e.exports=n},function(e,o){e.exports=require("request")},function(e,o,s){const n=new(s(0))({prefix:"/webhook"});e.exports=function(e){return n.post("/orders/create",e,async e=>{console.log("> New order created!")}),n}},function(e,o,s){const n=new(s(0))({prefix:"/plan"}),t=s(1);e.exports=function(e){return n.get("/basic",e(),async e=>{const o=e.session.shop,s=await t.findShopByName(o);if("basic"==s.plan)return void e.redirect("https://"+o+"/admin/apps/"+process.env.APP_NAME);const n=await t.getSubscriptionUrl(o,s.access_token,"basic",process.env.APP_BASIC_PLAN_FEE);console.log(n),console.log(o),console.log(s.access_token),console.log(process.env.APP_BASIC_PLAN_FEE),e.redirect(n)}),n.get("/paid",e(),e=>{console.log("paid--get"),console.log(e.query),console.log(e.request.body),console.log(e.params)}),n.post("/paid",e(),e=>{console.log("paid--post"),console.log(e.query),console.log(e.request.body),console.log(e.params)}),n}}]);