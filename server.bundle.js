!function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e,t){e.exports={SUBSCRIPTION:{PLAN:{TRIAL:0,BASIC:1,PREMIUM:2},PLAN_NAME:{BASIC:"basic",PREMIUM:"premium"},STATUS:{TRIAL:0,ACTIVE:1,CANCELLED:2,DECLINED:3,EXPIRED:4},SHOPIFY_STATUS:{ACTIVE:"ACTIVE",CANCELLED:"CANCELLED",EXPIRED:"EXPIRED"}},SLACK:{CONNECTED:1,DISCONNECTED:0},SETTING:{DISABLED:0,ENABLED:1,LOCKED:2},NOTIFICATION:{KEYS:["new_order","cancelled_order","paid_order","fulfilled_order","partially_fulfilled_order","sales_report"],NEW_ORDER:{TITLE:"New order notification",DESCRIPTION:"Automatically triggered when a new order is created. Includes order ID, customer's name and email, delivery location, cart total, discount code used(if any), tags(if any) and a link to access the order in Shopify."},CANCELLED_ORDER:{TITLE:"Cancelled order notification",DESCRIPTION:"Automatically triggered when an order is cancelled. Includes order ID, customer's name and email, delivery location, cart total, refunded amount, discount code used, tags and a link to access the order in Shopify."},PAID_ORDER:{TITLE:"Paid order notification",DESCRIPTION:"Automatically triggered when an order's payment is completed. Includes order ID, customer's name and email, delivery location, cart total, refunded amount, discount code used, tags and a link to access the order in Shopify."},FULFILLED_ORDER:{TITLE:"Fulfilled order notification",DESCRIPTION:"Automatically triggered when an order's payment is fulfilled. Includes order ID, customer's name and email, delivery location, cart total, refunded amount, discount code used, tags and a link to access the order in Shopify."},PARTIALLY_FULFILLED_ORDER:{TITLE:"Partially fulfilled order notification",DESCRIPTION:"Automatically triggered when an order's payment is partially fulfilled. Includes order ID, customer's name and email, delivery location, cart total, refunded amount, discount code used, tags, fulfilled items and a link to access the order in Shopify."},SALES_REPORT:{TITLE:"Daily sales report",DESCRIPTION:"A daily summary of total revenue from the day before automatic notification is sent."}},TOAST:{HIDDEN:0,SHOW:1},ORDER:{TITLE:{NEW_ORDER:"New Order",CANCELLED_ORDER:"Cancelled Order",PAID_ORDER:"Paid Order",FULFILLED_ORDER:"Fulfilled Order",PARTIALLY_FULFILLED_ORDER:"Partially Fulfilled Order"},FULFILLMENT:{SUCCESS:"SUCCESS",CANCELLED:"CANCELLED"}},STATUS:{SUCCESS:"success",FAILED:"failed",CANCELLED:"cancelled"}}},function(e,t){e.exports=require("koa-router")},function(e,t,n){const{getCurrentTimestamp:o}=n(3);e.exports={addShop:function(e,t){const n=process.env.APP_FREE_TRIAL_PERIOD;this.findShopByName(e).then(s=>{if(!s){s={shop_origin:e,access_token:t,notifications:'{"new_order":true,"cancelled_order":true,"paid_order":true,"fulfilled_order":true,"partially_fulfilled_order":true,"sales_report":false}',first_installed_time:o(),trial_expiration_time:Math.floor((new Date).getTime()/1e3)+24*n*60*60};return new Promise((function(e,t){db.query("INSERT INTO shops SET ?",s,(function(n,o){return n?t(n):e(o)}))}))}this.updateShop(e,{access_token:t})})},findShopByName:function(e){return new Promise((function(t,n){db.query("SELECT * FROM shops WHERE shop_origin = ?",e,(function(e,o){return e?n(e):o.length>0?t(o[0]):t(null)}))}))},updateShop:function(e,t){return new Promise((function(n,o){db.query("UPDATE shops SET ? WHERE shop_origin = ?",[t,e],(function(e,t){return e?o(e):n(t)}))}))},updateSubscriptionStatus:function(e,t){this.updateShop(e,{subscription_status:t})},updateSubscription:function(e,t){return new Promise((function(n,o){db.query("UPDATE shops SET ? WHERE subscription_id = ?",[t,e],(function(e,t){return e?o(e):n(t)}))}))}}},function(e,t,n){const o=n(0);function s(e){return Math.floor((new Date).getTime()/1e3)>e}e.exports={getCurrentTimestamp:function(){const e=new Date;return`${e.getFullYear()}-${("0"+(e.getMonth()+1)).slice(-2)}-${("0"+e.getDate()).slice(-2)} ${("0"+e.getHours()).slice(-2)}:${("0"+e.getMinutes()).slice(-2)}:${("0"+e.getSeconds()).slice(-2)}`},getRemainingTimeInDay:function(e){const t=e-Math.floor((new Date).getTime()/1e3);return Math.ceil(t/86400)},isExpired:s,isSendable:function(e,t){if(e.subscription_plan==o.SUBSCRIPTION.PLAN.TRIAL){if(s(e.trial_expiration_time))return!1}else if(e.subscription_status!=o.SUBSCRIPTION.STATUS.ACTIVE)return!1;return e.notifications=JSON.parse(e.notifications),!!e.notifications[t]}}},function(e,t){e.exports=require("@shopify/koa-shopify-auth")},function(e,t){e.exports=require("@shopify/koa-shopify-graphql-proxy")},function(e,t,n){const{IncomingWebhook:o}=n(20),s=n(0);function i(e,t,n,s){const i=new o(e);let r=[{type:"button",text:"View Order",url:n}];s&&r.push({type:"button",text:"View Customer",url:s}),(async()=>{await i.send({text:" ",attachments:[{color:"#CBEFFF",fields:t,actions:r}]})})()}e.exports={sendNotification:i,sendNotificationFromOrder:function(e,t,n,o){let r=[],a=new Object;const c=`https://${n}/admin/orders/${e.id}`;a.title=s.ORDER.TITLE[t]+":",a.value=`<${c}|${e.name}>`,r.push(a),a=new Object;const l=e.customer;a.title="Customer:",a.value=l?`${l.first_name} ${l.last_name} <${l.email}>`:"No customer info provided for this order",r.push(a),a=new Object;const u=e.shipping_address;if(a.title="Delivery Location:",u){let e="";u.address1&&(e=e+u.address1+", "),u.address2&&(e=e+u.address2+", "),u.city&&(e=e+u.city+", "),u.province&&(e=e+u.province+", "),u.country&&(e+=u.country),a.value=e}else a.value="No delivery location provided for this order";if(r.push(a),a=new Object,a.title="Cart Total:",a.value=`${e.total_price} ${e.currency}`,r.push(a),a=new Object,e.refunds.length>0){let t=0;e.refunds.forEach(e=>{e.transactions.forEach(e=>{t+=parseFloat(e.amount)})}),t>0&&(a.title="Refunded Amount:",t=t.toFixed(2),a.value=`${t} ${e.currency}`,r.push(a),a=new Object)}const d=e.discount_codes;if(d.length>0){let e="";a.title="Discount Codes:",d.forEach(t=>{e=e+t.code+", "}),a.value=e.slice(0,-2),r.push(a),a=new Object}e.tags&&(a.title="Tags:",a.value=e.tags,r.push(a),a=new Object);const p=e.line_items;a.title="Line Items:",a.value="",p.forEach(e=>{a.value=a.value+`- ${e.quantity} x ${e.title}\n`}),r.push(a),a=new Object,"PARTIALLY_FULFILLED_ORDER"==t&&e.fulfillments.length>0&&(a.title="Fulfilled Items:",a.value="",e.fulfillments.forEach(e=>{e.status!=s.STATUS.CANCELLED&&(e.tracking_company&&(a.value=a.value+`- ${e.tracking_company}\n`),e.line_items.forEach(e=>{a.value=a.value+` • ${e.quantity} x ${e.title}\n`}))}),a.value||(a.value="No items fulfilled"),r.push(a),a=new Object);let f=null;l&&(f=`https://${n}/admin/customers/${l.id}`),i(o.slack_webhook_url,r,c,f)}}},function(e,t,n){n(8),n(9).config(),n(10);const o=n(11),s=n(12),i=n(13),{default:r}=n(4),{verifyRequest:a}=n(4),c=n(14),l=n(15),u=n(1),d=n(16),p=n(17),{default:f}=n(5),{ApiVersion:h}=n(5),{receiveWebhook:S,registerWebhook:E}=n(18);var I=i.createConnection({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME});I.connect((function(e){if(e)throw e;console.log("> Connected to mysql server")})),global.db=I;const m=parseInt(process.env.PORT,10)||3e3,y=s({dev:!1}),T=y.getRequestHandler(),{SHOPIFY_API_SECRET_KEY:_,SHOPIFY_API_KEY:L,HOST:A}=process.env;y.prepare().then(()=>{const e=new o;e.context.db=I,e.use(c({secure:!0,sameSite:"none"},e)),e.keys=[_],e.use(r({apiKey:L,secret:_,scopes:["read_orders","write_orders","read_customers"],accessMode:"offline",async afterAuth(e){const{shop:t,accessToken:o}=e.session;e.cookies.set("shopOrigin",t,{httpOnly:!1,secure:!0,sameSite:"none"}),console.log(`> Authenticated: ${t} - ${o}`);const s=n(2);Promise.all([E({address:A+"/webhook/orders/create",topic:"ORDERS_CREATE",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/orders/cancelled",topic:"ORDERS_CANCELLED",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/orders/paid",topic:"ORDERS_PAID",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/orders/fulfilled",topic:"ORDERS_FULFILLED",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/orders/partially_fulfilled",topic:"ORDERS_PARTIALLY_FULFILLED",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/subscriptions/update",topic:"APP_SUBSCRIPTIONS_UPDATE",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/shop/update",topic:"SHOP_UPDATE",accessToken:o,shop:t,apiVersion:h.July20}),E({address:A+"/webhook/app/uninstalled",topic:"APP_UNINSTALLED",accessToken:o,shop:t,apiVersion:h.July20}),s.addShop(t,o)]).then(e=>{e[0].success&&e[1].success&&e[2].success&&e[3].success&&e[4].success&&e[5].success&&e[6].success&&e[7].success?console.log("> Webhook Registered: "+t):console.log("> Webhook registration failed: "+t)}),e.redirect("https://"+t+"/admin/apps/"+process.env.APP_NAME)}})),e.use(f({version:h.July20})),e.use(d("./public")),e.use(l());const t=new u,s=S({secret:_}),i=n(19)(s),y=n(21)(a);t.all("/(.*)",a(),async e=>{await T(e.req,e.res),e.respond=!1,e.res.statusCode=200}),e.use(i.routes()),e.use(i.allowedMethods()),e.use(p()),e.use(y.routes()),e.use(y.allowedMethods()),e.use(t.routes()),e.use(t.allowedMethods()),e.listen(m,()=>{console.log("> Server started on port: "+m)})}),new(0,n(23).CronJob)("0 * * * * *",(function(){console.log("> Check: ",new Date)}),null,!0).start()},function(e,t){e.exports=require("isomorphic-fetch")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("module-alias/register")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("next")},function(e,t){e.exports=require("mysql")},function(e,t){e.exports=require("koa-session")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("@shopify/koa-shopify-webhooks")},function(e,t,n){const o=new(n(1))({prefix:"/webhook"}),s=n(2),i=n(0),{isSendable:r}=n(3),{sendNotificationFromOrder:a}=n(6);e.exports=function(e){return o.post("/orders/create",e,async e=>{const t=e.headers["x-shopify-shop-domain"],n=e.request.body;console.log(`> New order created: ${t} - ${n.id}`);const o=await s.findShopByName(t);r(o,"new_order")&&a(n,"NEW_ORDER",t,o)}),o.post("/orders/cancelled",e,async e=>{const t=e.headers["x-shopify-shop-domain"],n=e.request.body;console.log(`> Order cancelled: ${t} - ${n.id}`);const o=await s.findShopByName(t);r(o,"cancelled_order")&&a(n,"CANCELLED_ORDER",t,o)}),o.post("/orders/paid",e,async e=>{const t=e.headers["x-shopify-shop-domain"],n=e.request.body;console.log(`> Order paid: ${t} - ${n.id}`);const o=await s.findShopByName(t);r(o,"paid_order")&&a(n,"PAID_ORDER",t,o)}),o.post("/orders/fulfilled",e,async e=>{const t=e.headers["x-shopify-shop-domain"],n=e.request.body;console.log(`> Order fulfilled: ${t} - ${n.id}`);const o=await s.findShopByName(t);r(o,"fulfilled_order")&&a(n,"FULFILLED_ORDER",t,o)}),o.post("/orders/partially_fulfilled",e,async e=>{const t=e.headers["x-shopify-shop-domain"],n=e.request.body;console.log(`> Order partially fulfilled: ${t} - ${n.id}`);const o=await s.findShopByName(t);r(o,"partially_fulfilled_order")&&a(n,"PARTIALLY_FULFILLED_ORDER",t,o)}),o.post("/subscriptions/update",e,async e=>{const t=e.request.body.app_subscription;if(t.status!=i.SUBSCRIPTION.SHOPIFY_STATUS.ACTIVE&&t.status!=i.SUBSCRIPTION.SHOPIFY_STATUS.CANCELLED&&t.status!=i.SUBSCRIPTION.SHOPIFY_STATUS.EXPIRED)return;const n=t.admin_graphql_api_id.split("/")[4];let o=t.name;o=o.split(" ")[1];let r=i.SUBSCRIPTION.PLAN.BASIC;o==i.SUBSCRIPTION.PLAN_NAME.PREMIUM&&(r=i.SUBSCRIPTION.PLAN.PREMIUM);const a=i.SUBSCRIPTION.STATUS[t.status];s.updateSubscription(n,{subscription_plan:r,subscription_status:a}),console.log(`> Subscription updated: ${n} - ${o} - ${t.status}`)}),o.post("/app/uninstalled",e,async e=>{const t=e.request.body.myshopify_domain;s.updateSubscriptionStatus(t,i.SUBSCRIPTION.STATUS.CANCELLED),console.log("> App uninstalled: "+t)}),o.post("/shop/update",e,async e=>{if(e.request.body.plan_name!=i.STATUS.CANCELLED)return;const t=e.request.body.myshopify_domain;s.updateSubscriptionStatus(t,i.SUBSCRIPTION.STATUS.CANCELLED),console.log("> Shop plan cancelled: "+t)}),o}},function(e,t){e.exports=require("@slack/webhook")},function(e,t,n){const o=new(n(1)),s=n(22),i=n(2),r=n(0),a=n(3),{sendNotification:c}=n(6);e.exports=function(e){return o.get("/api/settings",e(),e=>{const t=e.session.shop;return new Promise((function(n,o){i.findShopByName(t).then(t=>{let o=!0,s=0,i=!1;t.subscription_plan!=r.SUBSCRIPTION.PLAN.TRIAL?(o=!1,i=t.subscription_status==r.SUBSCRIPTION.STATUS.ACTIVE):a.isExpired(t.trial_expiration_time)?o=!1:s=a.getRemainingTimeInDay(t.trial_expiration_time),e.body={trial:o,trialExpiration:s,paid:i,connected:!!t.is_slack_connected,plan:t.subscription_plan,settings:JSON.parse(t.notifications)},n()})}))}),o.post("/api/settings",e(),e=>{var t=e.request.body.settings;if(!t||Object.keys(t).length!=r.NOTIFICATION.KEYS.length)return void(e.body={result:r.STATUS.FAILED});for(var n=0;n<r.NOTIFICATION.KEYS.length;n++){var o=r.NOTIFICATION.KEYS[n];if(!t.hasOwnProperty(o))return void(e.body={result:r.STATUS.FAILED});t[o]?t[o]=!0:t[o]=!1}const s=e.session.shop;return new Promise((function(n,o){i.findShopByName(s).then(o=>{o.subscription_plan==r.SUBSCRIPTION.PLAN.PREMIUM&&o.subscription_status==r.SUBSCRIPTION.STATUS.ACTIVE||(t.sales_report=!1),i.updateShop(s,{notifications:JSON.stringify(t)}),e.body={result:r.STATUS.SUCCESS},n()})}))}),o.get("/test",e(),async e=>{const t=e.session.shop,n=await i.findShopByName(t),o=JSON.stringify({query:"{\n        shop {\n          currencyFormats {\n            moneyFormat\n          }\n        }\n        orders(first: 1, reverse: true)\t{\n          edges {\n            node {\n              legacyResourceId\n              displayFinancialStatus\n              displayFulfillmentStatus\n              name\n              customer {\n                legacyResourceId\n                displayName\n                email\n              }\n              shippingAddress {\n                address1\n                address2\n                city\n                province\n                country\n                phone\n              }\n              totalPriceSet {\n                shopMoney {\n                  amount\n                }\n              }\n              totalRefundedSet{\n                shopMoney {\n                  amount\n                }\n              }\n              tags\n              discountCode\n              lineItems(first: 50) {\n                edges {\n                  node {\n                    name\n                    quantity\n                  }\n                }\n              }\n              refunds {\n                refundLineItems(first: 50) {\n                  edges {\n                    node {\n                      lineItem {\n                        name\n                      }\n                      quantity\n                    }\n                  }\n                }\n              }\n              fulfillments {\n                status\n                trackingInfo {\n                  company\n                }\n                fulfillmentLineItems(first: 50) {\n                  edges {\n                    node {\n                      lineItem {\n                        name\n                      }\n                      quantity\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }"});return new Promise((function(s,i){fetch(`https://${t}/admin/api/2020-07/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":n.access_token},body:o}).then(e=>e.json()).then(o=>{const i=o.data.orders.edges;if(0==i.length)e.body={result:r.STATUS.FAILED};else{const s=o.data.shop.currencyFormats.moneyFormat,a=i[0].node;let l=[],u=new Object,d=a.displayFinancialStatus,p=a.displayFulfillmentStatus,f="";"FULFILLED"==p?f="FULFILLED_ORDER":"PARTIALLY_FULFILLED"==p?f="PARTIALLY_FULFILLED_ORDER":"PAID"==d||"PARTIALLY_REFUNDED"==d?f="PAID_ORDER":"PENDING"==d&&(f="NEW_ORDER"),"VOIDED"!=d&&"REFUNDED"!=d||(f="CANCELLED_ORDER"),u.title=r.ORDER.TITLE[f]+":";const h=`https://${t}/admin/orders/${a.legacyResourceId}`;u.value=`<${h}|${a.name}>`,l.push(u),u=new Object,u.title="Customer:";const S=a.customer;u.value=S?`${S.displayName} <${S.email}>`:"No customer info provided for this order",l.push(u),u=new Object,u.title="Delivery Location:";const E=a.shippingAddress;if(E){let e="";E.address1&&(e=e+E.address1+", "),E.address2&&(e=e+E.address2+", "),E.city&&(e=e+E.city+", "),E.province&&(e=e+E.province+", "),E.country&&(e+=E.country),u.value=e}else u.value="No delivery location provided for this order";l.push(u),u=new Object,u.title="Cart Total:";let I=parseFloat(a.totalPriceSet.shopMoney.amount);I=I.toFixed(2);const m=s.replace("{{amount}}",I);u.value=m,l.push(u),u=new Object;let y=parseFloat(a.totalRefundedSet.shopMoney.amount);if(y){u.title="Refunded Amount:",y=y.toFixed(2);const e=s.replace("{{amount}}",y);u.value=e,l.push(u),u=new Object}if(a.discountCode&&(u.title="Discount Codes:",u.value=a.discountCode,l.push(u),u=new Object),a.tags.length){u.title="Tags:";let e="";a.tags.forEach(t=>{e=e+t+", "}),u.value=e.slice(0,-2),l.push(u),u=new Object}u.title="Line Items:",u.value="",a.lineItems.edges.forEach(e=>{u.value=u.value+`- ${e.node.quantity} x ${e.node.name}\n`}),l.push(u),u=new Object,"PARTIALLY_FULFILLED_ORDER"==f&&a.fulfillments.length>0&&(u.title="Fulfilled Items:",u.value="",a.fulfillments.forEach(e=>{e.status!=r.ORDER.FULFILLMENT.CANCELLED&&(e.trackingInfo.length>0&&(u.value=u.value+`- ${e.trackingInfo[0].company}\n`),e.fulfillmentLineItems.edges.forEach(e=>{u.value=u.value+`• ${e.node.quantity} x ${e.node.lineItem.name}\n`}))}),u.value||(u.value="No items fulfilled"),l.push(u),u=new Object);let T=null;T=S?`https://${t}/admin/customers/${S.legacyResourceId}`:null,c(n.slack_webhook_url,l,h,T),e.body={result:r.STATUS.SUCCESS}}s()})}))}),o.get("/api/subscription",e(),async e=>{const t=e.session.shop,n=await i.findShopByName(t),o=e.query.plan.toUpperCase();if(!r.SUBSCRIPTION.PLAN[o]||n.subscription_plan==r.SUBSCRIPTION.PLAN[o])return void e.redirect(`https://${t}/admin/apps/${process.env.APP_NAME}`);console.log(`> Chosen a plan: ${t} - ${o}`);var s=process.env.APP_BASIC_PLAN_FEE;o==r.SUBSCRIPTION.PLAN_NAME.PREMIUM&&(s=process.env.APP_PREMIUM_PLAN_FEE);const a=JSON.stringify({query:`mutation {\n        appSubscriptionCreate(\n          name: "Slackify ${o} plan fee"\n          returnUrl: "${process.env.HOST}/subscription/callback"\n          test: true\n          lineItems: [\n            {\n              plan: {\n                appRecurringPricingDetails: {\n                  price: { amount: ${s}, currencyCode: USD }\n                  interval: EVERY_30_DAYS\n                }\n              }\n            }\n          ]\n        ) {\n          userErrors {\n            field\n            message\n          }\n          confirmationUrl\n          appSubscription {\n            id\n          }\n        }\n      }`});return new Promise((function(o,s){fetch(`https://${t}/admin/api/2020-07/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":n.access_token},body:a}).then(e=>e.json()).then(t=>{const n=t.data.appSubscriptionCreate.confirmationUrl;e.redirect(n),o()})}))}),o.get("/subscription/callback",e(),e=>{const t=e.session.shop,n=e.query.charge_id,o={subscription_id:n,subscription_status:r.SUBSCRIPTION.STATUS.ACTIVE,subscription_activated_time:a.getCurrentTimestamp()};i.updateShop(t,o),console.log(`> Subscription activated: ${t} - ${n}`),e.redirect(`https://${t}/admin/apps/${process.env.APP_NAME}/subscription`)}),o.get("/slack/oauth",e(),e=>{const t=e.session.shop;if(e.query.code)return new Promise((function(n,o){s({url:"https://slack.com/api/oauth.v2.access",qs:{code:e.query.code,client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET},method:"GET"},(function(o,s,a){if(o)console.log("> Slack authentication error: "+o),e.response.status=500,e.response.body="Failed to add Slackify to a Slack channel.",n();else{const o=JSON.parse(a);o.ok?(i.updateShop(t,{slack_access:a,slack_webhook_url:o.incoming_webhook.url,is_slack_connected:r.SLACK.CONNECTED}),e.response.body="Connected to slack channel",e.redirect(`https://${t}/admin/apps/${process.env.APP_NAME}`)):(console.log("> Slack authentication failed: "+o.error),e.response.status=500,e.response.body="Failed to add Slackify to the Slack channel."),n()}}))}));console.log("> Invalid slack authentication code: "+t),e.response.status=500,e.response.body="Invalid slack authentication code."}),o}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("cron")}]);