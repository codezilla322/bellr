!function(e){var s={};function o(t){if(s[t])return s[t].exports;var n=s[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=s,o.d=function(e,s,t){o.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,s){if(1&s&&(e=o(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var n in e)o.d(t,n,function(s){return e[s]}.bind(null,n));return t},o.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(s,"a",s),s},o.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},o.p="",o(o.s=6)}([function(e,s){e.exports=require("koa-router")},function(e,s,o){const t=o(4);e.exports={addShop:function(e,s){const o=process.env.APP_FREE_TRIAL_PERIOD;this.findShopByName(e).then(n=>{if(!n){n={shop_origin:e,access_token:s,first_installed_time:t.getCurrentTimestamp(),trial_expiration_time:Math.floor((new Date).getTime()/1e3)+24*o*60*60};return new Promise((function(e,s){db.query("INSERT INTO shops SET ?",n,(function(o,t){return o?s(o):e(t)}))}))}this.updateShop(e,{access_token:s})})},findShopByName:function(e){return new Promise((function(s,o){db.query("SELECT * FROM shops WHERE shop_origin = ?",e,(function(e,t){return e?o(e):t.length>0?s(t[0]):s(null)}))}))},updateShop:function(e,s){return new Promise((function(o,t){db.query("UPDATE shops SET ? WHERE shop_origin = ?",[s,e],(function(e,s){return e?t(e):o(s)}))}))},updateSubscriptionStatus:function(e,s){this.updateShop(e,{subscription_status:s})},updateSubscription:function(e,s){return new Promise((function(o,t){db.query("UPDATE shops SET ? WHERE subscription_id = ?",[s,e],(function(e,s){return e?t(e):o(s)}))}))}}},function(e,s){e.exports=require("@shopify/koa-shopify-auth")},function(e,s){e.exports=require("@shopify/koa-shopify-graphql-proxy")},function(e,s){e.exports={getCurrentTimestamp:function(){const e=new Date;return`${e.getFullYear()}-${("0"+(e.getMonth()+1)).slice(-2)}-${("0"+e.getDate()).slice(-2)} ${("0"+e.getHours()).slice(-2)}:${("0"+e.getMinutes()).slice(-2)}:${("0"+e.getSeconds()).slice(-2)}`},getRemainingTime:function(e){const s=e-Math.floor((new Date).getTime()/1e3);return Math.ceil(s/86400)},isExpired:function(e){return Math.floor((new Date).getTime()/1e3)>e}}},function(e,s){e.exports={subscription:{plan:{TRIAL:0,BASIC:1,PREMIUM:2},status:{TRIAL:0,ACTIVE:1,CANCELLED:2,DECLINED:3,EXPIRED:4}},slack:{CONNECTED:1,DISCONNECTED:0}}},function(e,s,o){o(7),o(8).config(),o(9);const t=o(10),n=o(11),i=o(12),{default:r}=o(2),{verifyRequest:c}=o(2),a=o(13),u=o(14),p=o(0),l=o(15),d=o(16),{default:f}=o(3),{ApiVersion:h}=o(3),{receiveWebhook:_,registerWebhook:b}=o(17);var E=i.createConnection({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME});E.connect((function(e){if(e)throw e;console.log("> Connected to mysql server")})),global.db=E;const y=parseInt(process.env.PORT,10)||3e3,S=n({dev:!1}),m=S.getRequestHandler(),{SHOPIFY_API_SECRET_KEY:g,SHOPIFY_API_KEY:k,HOST:T}=process.env;S.prepare().then(()=>{const e=new t;e.context.db=E,e.use(a({secure:!0,sameSite:"none"},e)),e.keys=[g],e.use(r({apiKey:k,secret:g,scopes:["read_orders","write_orders"],accessMode:"offline",async afterAuth(e){const{shop:s,accessToken:t}=e.session;e.cookies.set("shopOrigin",s,{httpOnly:!1,secure:!0,sameSite:"none"}),console.log(`> Authenticated: ${s} - ${t}`);const n=o(1);Promise.all([b({address:T+"/webhook/orders/create",topic:"ORDERS_CREATE",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/orders/cancelled",topic:"ORDERS_CANCELLED",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/orders/paid",topic:"ORDERS_PAID",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/orders/fulfilled",topic:"ORDERS_FULFILLED",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/orders/partially_fulfilled",topic:"ORDERS_PARTIALLY_FULFILLED",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/subscriptions/update",topic:"APP_SUBSCRIPTIONS_UPDATE",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/shop/update",topic:"SHOP_UPDATE",accessToken:t,shop:s,apiVersion:h.July20}),b({address:T+"/webhook/app/uninstalled",topic:"APP_UNINSTALLED",accessToken:t,shop:s,apiVersion:h.July20}),n.addShop(s,t)]).then(e=>{e[0].success&&e[1].success&&e[2].success&&e[3].success&&e[4].success&&e[5].success&&e[6].success&&e[7].success?console.log("> Webhook Registered: "+s):console.log("> Webhook registration failed: "+s)}),e.redirect("https://"+s+"/admin/apps/"+process.env.APP_NAME)}})),e.use(f({version:h.July20})),e.use(l("./public")),e.use(u());const s=new p,n=_({secret:g}),i=o(18)(n),S=o(19)(c);s.all("/(.*)",c(),async e=>{await m(e.req,e.res),e.respond=!1,e.res.statusCode=200}),e.use(i.routes()),e.use(i.allowedMethods()),e.use(d()),e.use(S.routes()),e.use(S.allowedMethods()),e.use(s.routes()),e.use(s.allowedMethods()),e.listen(y,()=>{console.log("> Server started on port: "+y)})})},function(e,s){e.exports=require("isomorphic-fetch")},function(e,s){e.exports=require("dotenv")},function(e,s){e.exports=require("module-alias/register")},function(e,s){e.exports=require("koa")},function(e,s){e.exports=require("next")},function(e,s){e.exports=require("mysql")},function(e,s){e.exports=require("koa-session")},function(e,s){e.exports=require("@koa/cors")},function(e,s){e.exports=require("koa-static")},function(e,s){e.exports=require("koa-body")},function(e,s){e.exports=require("@shopify/koa-shopify-webhooks")},function(e,s,o){const t=new(o(0))({prefix:"/webhook"}),n=o(1),i=o(5);e.exports=function(e){return t.post("/orders/create",e,async e=>{console.log("> New order created: ")}),t.post("/subscriptions/update",e,async e=>{e.body="ok";const s=e.request.body.app_subscription;if("ACTIVE"!=s.status&&"CANCELLED"!=s.status&&"EXPIRED"!=s.status)return;const o=s.admin_graphql_api_id.split("/")[4];let t=s.name;t=t.split(" ")[1];let r=i.subscription.plan.BASIC;"premium"==t&&(r=i.subscription.plan.PREMIUM);const c=i.subscription.status[s.status];n.updateSubscription(o,{subscription_plan:r,subscription_status:c}),console.log(`> Subscription updated: ${o} - ${t} - ${s.status}`)}),t.post("/app/uninstalled",e,async e=>{const s=e.request.body.myshopify_domain;n.updateSubscriptionStatus(s,i.subscription.status.CANCELLED),console.log("> App uninstalled: "+s)}),t.post("/shop/update",e,async e=>{if("cancelled"!=e.request.body.plan_name)return;const s=e.request.body.myshopify_domain;n.updateSubscriptionStatus(s,i.subscription.status.CANCELLED),console.log("> Shop plan cancelled: "+s)}),t}},function(e,s,o){const t=new(o(0)),n=o(1),i=o(4),r=o(5),c=o(20);e.exports=function(e){return t.get("/api/settings",e(),async e=>{console.log(i.getCurrentTimestamp());const s=e.session.shop;return new Promise((function(o,t){n.findShopByName(s).then(s=>{let t=!0,n=0,c=!1;s.subscription_plan!=r.subscription.plan.TRIAL?(t=!1,c=s.subscription_status==r.subscription.status.ACTIVE):i.isExpired(s.trial_expiration_time)?t=!1:n=i.getRemainingTime(s.trial_expiration_time),e.body={trial:t,trialExpiration:n,paid:c,connected:!!s.is_slack_connected,plan:s.subscription_plan},o()})}))}),t.post("/api/settings",e(),async e=>{}),t.get("/api/subscription",e(),async e=>{const s=e.session.shop,o=await n.findShopByName(s),t=e.query.plan.toUpperCase();if(!r.subscription.plan[t]||o.subscription_plan==r.subscription.plan[t])return void e.redirect(`https://${s}/admin/apps/${process.env.APP_NAME}`);console.log(`> Chosen a plan: ${s} - ${t}`);var i=process.env.APP_BASIC_PLAN_FEE;"premium"==t&&(i=process.env.APP_PREMIUM_PLAN_FEE);const c=JSON.stringify({query:`mutation {\n        appSubscriptionCreate(\n          name: "Slackify ${t} plan fee"\n          returnUrl: "${process.env.HOST}/subscription/callback"\n          test: true\n          lineItems: [\n            {\n              plan: {\n                appRecurringPricingDetails: {\n                  price: { amount: ${i}, currencyCode: USD }\n                  interval: EVERY_30_DAYS\n                }\n              }\n            }\n          ]\n        ) {\n          userErrors {\n            field\n            message\n          }\n          confirmationUrl\n          appSubscription {\n            id\n          }\n        }\n      }`}),a=await fetch(`https://${s}/admin/api/2020-07/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":o.access_token},body:c}),u=(await a.json()).data.appSubscriptionCreate.confirmationUrl;e.redirect(u)}),t.get("/subscription/callback",e(),e=>{const s=e.session.shop,o=e.query.charge_id,t={subscription_id:o,subscription_status:r.subscription.status.ACTIVE,subscription_activated_time:i.getCurrentTimestamp()};n.updateShop(s,t),console.log(`> Subscription activated: ${s} - ${o}`),e.redirect(`https://${s}/admin/apps/${process.env.APP_NAME}`)}),t.get("/slack/oauth",e(),async e=>{const s=e.session.shop;if(e.query.code)return new Promise((function(o,t){c({url:"https://slack.com/api/oauth.v2.access",qs:{code:e.query.code,client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET},method:"GET"},(function(t,i,c){if(t)console.log("> Slack authentication error: "+t),e.response.status=500,e.response.body="Failed to add Slackify to a Slack channel.",o();else{const t=JSON.parse(c);t.ok?(n.updateShop(s,{slack_access:c,slack_webhook_url:t.incoming_webhook.url,is_slack_connected:r.slack.CONNECTED}),e.redirect(`https://${s}/admin/apps/${process.env.APP_NAME}`)):(console.log("> Slack authentication failed: "+t.error),e.response.status=500,e.response.body="Failed to add Slackify to the Slack channel."),o()}}))}));console.log("> Invalid slack authentication code: "+s),e.response.status=500,e.response.body="Invalid slack authentication code."}),t}},function(e,s){e.exports=require("request")}]);